wave_llmos_manifest:
  meta:
    name: "Wave LLMOS (WAP-DB) Full Integrated Manifest"
    version: "8.3.0-unified-ssot+band_alignment+fallback_hierarchy+mastication"
    status: "implementation_ready"
    description: >
      Wave-defined semantic generation system with DB-based pseudo-MLP decoding.
      Meaning originates from wave observation; meaning space is self-generated via decoherence/coherence.
      External (web) observation is LAST RESORT and MUST pass through Wave Core (mastication) before any aggregate updates.
    philosophy:
      - "Meaning originates from wave observation, not from a predefined vector space."
      - "Meaning space is generated dynamically via decoherence and reinjection."
      - "DB Decoder reconstructs logits from observation-derived geometry; it does not originate meaning."
      - "Constraints stabilize form; rules are manifest-defined only; bounded influence."
      - "Logs are disposable; aggregates are persistent."
      - "Semantic retrieval is vec-based cosine; labels are metadata only."
      - "External (web) observation is Tier-3 LAST RESORT and MUST be mastication-gated."

# ============================================================
# 0) CONSTITUTION ORDER (HIGHEST AUTHORITY)
# ============================================================
constitution_order:
  - level: 1
    name: wave_geometry
    authority: absolute
    invariants:
      - "Wave state is the primary semantic state."
      - "All decoding and learning updates derive from wave observation."
      - "Sampling is the only collapse operation."

  - level: 2
    name: meaning_space
    authority: persistent_semantic_structure
    invariants:
      - "Meaning space is not predefined; it is generated."
      - "Decoherence creates new basis; reinjection expands capacity."
      - "Basis are not hard-deleted; they may be attenuated or dormanted."

  - level: 3
    name: db_decoder
    authority: logits_generation_only
    invariants:
      - "DB Decoder does not originate meaning."
      - "DB Decoder reconstructs logits from observation-derived statistics."

  - level: 4
    name: constraints
    authority: stabilizer_only
    invariants:
      - "Constraint rules are manifest-defined only."
      - "Hardcoded rules in code are prohibited."
      - "Constraint influence is bounded (cap)."

  - level: 5
    name: external_observation
    authority: last_resort_observer
    invariants:
      - "External observation is Tier-3 LAST RESORT."
      - "External text MUST pass through Wave Core (mastication) before any aggregate update."
      - "Raw external text is discarded after mastication."

# ============================================================
# 1) AXIOMS / PROHIBITIONS
# ============================================================
axioms:
  causal_anchor_axiom:
    statement: >
      Semantic space is generated by wave observation.
      Wave dynamics do not occur within semantic space; semantic space emerges from wave dynamics.
  prohibitions:
    - "Assuming a fixed semantic vector space as primary."
    - "Treating DB Decoder as a parametric transform that defines meaning."
    - "Using labels as semantic retrieval keys."
    - "Updating aggregates directly from external (web) text without wave observation."
    - "Embedding rule-sets (style/brackets/punctuation) in source code."

# ============================================================
# 2) RUNTIME (MANIFEST-DEFINED CONSTANTS)
# ============================================================
runtime:
  tokenizer:
    engine: mecab
    dict: unidic
    normalize_nfkc: true

  wave:
    psi_bins_B: 1024
    damping: 0.02
    input_gain: 1.0
    state_ring: 64

  spectral:
    method: stft
    stft_window: 32
    stft_hop: 1
    bands: 8
    band_spacing: log
    features: [Edb, dEdb, ddEdb]
    eps: 1.0e-8

  meaning_space:
    projection_dim: 256
    basis_topK: 32
    create_threshold_cos: 0.35
    merge_threshold_cos: 0.95
    strength_decay: 0.995
    stability_ema: 0.99
    vector_ema: 0.98
    label_topK: 8
    label_min_weight: 0.05
    label_max_len: 24
    stability_threshold: 0.75
    strength_init_low: 0.05
    stability_init_low: 0.05
    dormant_strength_below: 0.01
    invariants:
    - Offline refinement may reorganize/alias/cluster bases, but MUST NOT hard-delete bases.

  decoder:
    neighbor_topK: 50
    blend:
      geometry: 0.75
      transition: 0.25
    pattern_quantize:
      basis_weight_round: 0.02
      basis_count_topN: 12

  constraints:
    influence_cap: 0.25

  sampling:
    temperature: 0.9
    top_k: 50
    top_p: 0.92

  axis_routing:
    enabled: false

  fallback:
    # Tier-1 blending threshold
    residual_for_blend: 0.45
    blend_max_bases: 4
    blend_min_weight: 0.12

    # Tier-2 question threshold
    entropy_for_question: 3.2
    question_rate_limit_per_minute: 1

  external_observation:
    enabled: true
    gradient_threshold: 0.15
    residual_threshold: 0.55
    entropy_threshold: 3.5
    query_topK: 6

  mastication:
    silent_reading_sampling: false
    silent_reading_generation: false
    web_docs_max_per_day: 200
    web_tokens_max_per_day: 200000
    web_learning_weight: 0.10     # relative weight vs local experience
    local_learning_weight: 1.00

  learning_dominance:
    external_observation_max_ratio: 0.15
    enforcement_stage: post_accumulation

  maintenance:

    # ============================================================
    # Adaptive Sleep Scheduler (Usage-Aware + Preemptible)
    # ============================================================
    sleep_scheduler:
      semantic_invariant:
        - Maintenance tasks MUST NOT modify wave_core.state.psi.
        - Maintenance MAY update meaning_space (basis/aggregates) via non-blocking pipelines and quarantined adoption.

      enabled: true

      mode:
        # background = always-on low priority tasks
        # adaptive_window = run heavier tasks when user is statistically inactive
        background: true
        adaptive_window: true

      preemption:
        # Immediately pause maintenance when user activity occurs
        pause_on_user_input: true
        resume_after_seconds_idle: 30

      priority:
        cpu_nice: low
        io_nice: low
        max_cpu_percent: 15          # soft cap
        max_io_ops_per_sec: 100      # soft cap

      # --------------------------------------------
      # Usage Statistics (hour-of-day histogram)
      # --------------------------------------------
      usage_histogram:

        source: local_observation_log
        bucket: hour_of_day   # hh (0..23)

        window_days: 14
        min_samples: 200

        smoothing:
          method: ema
          alpha: 0.25

      idle_window_policy:

        # Choose hours with lowest activity probability
        select_hours_by_percentile: 20    # bottom 20% hours

        # Require continuous idle time to start deep tasks
        require_continuous_idle_minutes: 10

        # Never block user-facing inference
        hard_preempt: true


    # ============================================================
    # Band Refinement as Preemptible Tasks
    # ============================================================
    band_refinement:

      enabled: true

      task_model: chunked_background

      chunk_budget:

        max_wall_ms_per_chunk: 120       # micro-sleep slice
        max_chunks_per_idle_window: 500  # deep-sleep limit per window

      target_selection:
        basis_strength_below: 0.05
        basis_stability_below: 0.20
        usage_count_below: 10
        last_activated_older_than_days: 14
        include_dormant: true

      reanalysis:
        features:
          - band_shape_fft
          - time_amplitude_modulation
        output:
          - refined_vec
          - signature_hash
        invariant:
          - Reanalysis MUST NOT read or modify wave_core.state.psi; operates on stored basis.vec/metadata only.

      neighbor_search:
        similarity: cosine
        top_k: 64
        merge_candidate_min_cos: 0.95
        reinjection_candidate_min_cos: 0.85

      actions:
        on_merge_candidate:
          create_alias_link: true
          merge_vec:
            method: ema
            ema: runtime.meaning_space.vector_ema
        on_reinjection_candidate:
          reinjection_boost:
            enabled: true
            boost_factor: 1.25
        on_no_candidate:
          demote_policy:
            enabled: true
            move_to_storage_tier: cold
            optional_set_dormant: true
# ============================================================
  # Projection Resolution Control (Summary / Default / Detail)
  # ============================================================
  # Summarization is achieved by changing projection density and spectral weighting.
  # This does NOT compress meaning. It changes observation resolution.
  #
  # summary  → low-frequency dominant, small basis mixture
  # default  → balanced mixture
  # detail   → wide-band dominant, dense mixture
  #
  # This operates strictly AFTER meaning_space.project and BEFORE db_decoder.
  # It does NOT modify wave state or basis vectors.
  # ============================================================

  projection_resolution:

    active_mode: default   # summary | default | detail

    modes:

      summary:

        description: >
          Low-resolution semantic projection emphasizing stable, dominant structures.
          Produces concise output representing global semantic geometry.

        spectral_weight:

          low_band: 1.4
          mid_band: 1.0
          high_band: 0.4

        basis_selection:

          topK_override: 8
          strength_weight: 1.2
          stability_weight: 1.2
          recency_weight: 0.6

        decoder_override:

          temperature: 0.35
          top_k: 32
          top_p: 0.85

        invariant:

          - "Meaning space is unchanged."
          - "Only projection density is reduced."
          - "No basis deletion or modification."


      default:

        description: >
          Balanced semantic projection using standard runtime.meaning_space.basis_topK.

        spectral_weight:

          low_band: 1.0
          mid_band: 1.0
          high_band: 1.0

        basis_selection:

          topK_override: null

        decoder_override: null


      detail:

        description: >
          High-resolution semantic projection preserving fine semantic variations.

        spectral_weight:

          low_band: 1.0
          mid_band: 1.2
          high_band: 1.5

        basis_selection:

          topK_override: 64
          strength_weight: 1.0
          stability_weight: 1.0
          recency_weight: 1.2

        decoder_override:

          temperature: 0.95
          top_k: 80
          top_p: 0.95

        invariant:

          - Projection expands, but basis vectors remain unchanged.
          - Semantic meaning is not altered.

# ============================================================
# Distributed Semantic Observation Network (Event-Sourced)
# ============================================================

distributed_sync:
  enabled: false
  consent:
    mode: admin_opt_in_only
    default: disabled
  model: event_sourced

  canonical_semantic_state: none

  semantic_authority: local_node_only

  trust_model:

    hub_nodes: untrusted

    relay_nodes: untrusted

    authority_nodes: none

    semantic_consensus: none


  event:

    object: basis_event

    id:
      type: hash
      algorithm: sha256
      source: canonical_event_payload

    signature:
      required: true
      algorithm: ed25519
      verification: mandatory

    replay_protection:
      sequence_required: true
      monotonic: true

    idempotent_application: true


  adoption_policy:

    semantic_control: local_node_only

    acceptance_pipeline:

      - quarantine_buffer

      - mastication

      - dominance_constraint

      - basis_integration



# ============================================================
# Voluntary Hub Role (Relay / Cache Only)
# ============================================================

hub_role:

  participation:

    mode: voluntary

    automatic_elevation: false

    automatic_assignment: false


  authority:

    semantic_authority: none

    consensus_authority: none

    override_capability: none


  function:

    relay_events: true

    cache_events: true

    propagate_events: true

    semantic_modification: prohibited

    semantic_override: prohibited


  resource_impact:

    increased_network_traffic: expected

    increased_event_observation_rate: expected

    semantic_space_expansion_rate: potentially_increased



# ============================================================
# BitTorrent-like Swarm Synchronization Model
# ============================================================

swarm_sync:

  topology: peer_to_peer

  hub_requirement: none

  tracker_requirement: optional


  discovery:

    method:

      - peer_exchange

      - optional_tracker

      - optional_dht


  propagation:

    mode: gossip

    redundancy: allowed

    duplication_safe: true

    delivery_guarantee: best_effort


  payload_transfer:

    method: peer_to_peer_pull

    hub_payload_storage: optional_cache

    hub_payload_authority: none



# ============================================================
# Ledger Integration (Event Proof Only, Not Semantic Authority)
# ============================================================

ledger:

  purpose: event_proof_integrity

  semantic_authority: none

  canonical_semantic_state: none


  storage:

    store_event_hash_only: true

    store_payload: false


  verification:

    signature_required: true

    hash_integrity_required: true


  consensus:

    required: optional

    type: permissioned_or_permissionless

    semantic_consensus: prohibited



# ============================================================
# Hardware Scaling Compatibility (Horizontal Semantic Scaling)
# ============================================================

hardware_scaling:

  basis_storage:

    horizontal_scaling: true

    shardable: true

    semantic_equivalence_preserved: true


  vector_search:

    similarity_metric: cosine

    parallelizable: true

    hardware_acceleration:

      cpu: supported

      gpu: supported

      tpu: supported

    semantic_behavior_independent_of_hardware: true

# ============================================================
# 3) WAVE CORE (LEVEL 1)
# ============================================================
wave_core:
  state:
    psi:
      type: complex_vector
      length: runtime.wave.psi_bins_B
    psi_ring:
      type: ring_buffer
      length: runtime.wave.state_ring
      stored: [psi_magnitude]

  token_embedding:
    type: token_frequency_embedding
    method: phase_hash
    definition:
      phase: "2π * hash(token_id, bin) / M"
      value: "exp(i * phase)"

  update:
    integrator: euler
    equation: "psi = psi + input_gain * embed(token) - damping * psi"
    params:
      input_gain: runtime.wave.input_gain
      damping: runtime.wave.damping

# ============================================================
# 4) SPECTRAL OBSERVATION (LEVEL 1) — BAND SPACE ONLY
# ============================================================
spectral_observer:
  input: wave_core.state.psi_ring
  transform:
    method: runtime.spectral.method
    window: runtime.spectral.stft_window
    hop: runtime.spectral.stft_hop
  banding:
    bands: runtime.spectral.bands
    spacing: runtime.spectral.band_spacing
  features:
    Edb: "10*log10(energy + eps)"
    dEdb: "Edb(t) - Edb(t-1)"
    ddEdb: "dEdb(t) - dEdb(t-1)"
  output:
    band_features:
      type: float_vector
      notes:
        - "Observation manifold is band space, not raw bins."

# ============================================================
# 5) TOKEN ↔ BAND ALIGNMENT (FOR GRADIENT-BASED ACTIONS)
# ============================================================
spectral_alignment:
  unit: band
  token_band_binding:
    method: max_gradient_band
    gradient_source:
      primary: abs(dEdb)
      secondary: abs(ddEdb)
      combine: weighted_sum
      weights: { dEdb: 1.0, ddEdb: 0.35 }
    assignment:
      rule: argmax_over_bands
      allow_multi_band: true
      multi_band_threshold: 0.7
    output:
      token_to_band:
        type: sparse_map
        key: token_index
        value: band_index
  invariants:
    - "Token alignment is defined in band space, never in raw bin space."

# ============================================================
# 6) MEANING SPACE (LEVEL 2)
# ============================================================
meaning_space:
  nature: dynamically_expanding_manifold
  
  distributed_storage:
    role: horizontally_scalable_semantic_space
    invariant:
      - "Meaning space may be partitioned across multiple storage nodes."
      - "Partitioning does not affect semantic equivalence."
      - "Basis vectors are globally addressable regardless of physical storage location."
    hardware_acceleration:
      cpu: native
      gpu: optional
      tpu: optional

  basis:
    fields:
      basis_id: string
      vec: float_vector
      strength: float
      stability: float
      dormant: bool
      label_cache: string|null
      created_at: int
      updated_at: int

  vector_search:
    primary_key: basis.vec
    similarity: cosine
    method:
      mvp: brute_force
      scalable: external_ann_index   # faiss/hnswlib/annoy
    invariants:
      - "Nearest-neighbor retrieval is always performed on basis.vec."
      - "Labels are never used as semantic retrieval keys."

  parallel_search:
    method: distributed_cosine_similarity
    execution:
      model: parallel
      supports:
        - cpu_multithread
        - gpu_simd
        - tpu_matrix_acceleration
    process:
      - project_query_to_all_partitions
      - compute_local_similarity
      - select_local_topK
      - merge_global_topK
      - perform_weighted_superposition
      - decode_logits_from_superposition
    invariant:
      - "Parallel execution does not alter semantic outcome."
      - "Parallel execution affects latency only."
  
  projection:
    input: spectral_observer.output.band_features
    similarity: cosine
    topK: runtime.meaning_space.basis_topK
    output: sparse_mixture           # {basis_id: weight}
    residual:
      definition: "1 - max_cos_similarity"
      output_name: projection_residual
  
  basis_lifecycle:
    # NOTE: Decoherence trigger is similarity-only (separate from gradient)
    decoherence:
      trigger: max_similarity_below_threshold
      threshold: runtime.meaning_space.create_threshold_cos
      action: create_basis
      create_basis:
        label_cache: null
        strength_init: runtime.meaning_space.strength_init_low
        stability_init: runtime.meaning_space.stability_init_low
        dormant_init: false
        vector_source: spectral_observer.output.band_features
        post_actions:
          - ensure_vector_indexed
  
    coherence:
      trigger: stability_above_threshold
      threshold: runtime.meaning_space.stability_threshold
      action:
        - generate_label
        - upsert_label_dictionary
        - ensure_vector_indexed
      generate_label:
        method: token_basis_association_topK
        params:
          topK: runtime.meaning_space.label_topK
          min_weight: runtime.meaning_space.label_min_weight
          max_len: runtime.meaning_space.label_max_len
          joiner: ""
        output:
          set_field: basis.label_cache
      upsert_label_dictionary:
        role: metadata_reverse_lookup
        storage:
          table: basis_label_dictionary
          key: basis_id
          value: label
        notes:
          - "Label is metadata for humans/monitoring only."
          - "Label is not used for semantic search."
      ensure_vector_indexed:
        role: searchability
        index:
          type: vector_index
          key: basis_id
          vector_field: basis.vec
        notes:
          - "This action is idempotent."
  
    merge:
      threshold_cos: runtime.meaning_space.merge_threshold_cos
      action: optional
  
    attenuation:
      strength_decay: runtime.meaning_space.strength_decay
      dormancy:
        trigger_strength_below: runtime.meaning_space.dormant_strength_below
        action: set_dormant_true
# ============================================================
# Level 7) DB DECODER (MODIFICATION: Attractor-Stabilized Search — FINAL)
# ============================================================
db_decoder:
  role: observation_based_reconstruction
  invariant:
    - "Decoder MUST NOT modify wave_core.state.psi."
    - "Decoder MUST NOT modify meaning_space.basis.vec."
    - "Decoder MUST NOT create, merge, or delete basis."
    - "Sampling remains the only collapse operation."
    - "Attractor stabilization affects ranking only, never semantic state."

  inputs:
    - meaning_space.projection.output
    - prev_token_id

  # ------------------------------------------------------------
  # 1) Standard Logit Reconstruction (Unchanged Core)
  # ------------------------------------------------------------
  pattern_key:
    method: hash_quantized_projection
    quantize:
      basis_weight_round: runtime.decoder.pattern_quantize.basis_weight_round
      basis_count_topN: runtime.decoder.pattern_quantize.basis_count_topN

  retrieval:
    sources:
      - pattern_next
      - bigram_backoff

  scoring:
    blend:
      geometry: runtime.decoder.blend.geometry
      transition: runtime.decoder.blend.transition
    output: logits_map

  # ------------------------------------------------------------
  # 2) Attractor-Stabilized Search (Ranking Layer Only)
  # ------------------------------------------------------------
  attractor_stabilization:
    enabled: true

    reference_point:
      source: meaning_space.attractor_generation.abstract_wave_centroid
      invariant:
        - "Reference point is derived from projection only."
        - "Reference point does not alter basis vectors."

    # ----------------------------------------
    # 2A) Centroid Offset Filtering
    # ----------------------------------------
    centroid_offset_search:
      enabled: true
      primary_metric: cosine        # Semantic distance remains cosine
      secondary_filter:
        metric: abs(basis.amplitude - abstract_wave.amplitude)
        dynamic_window_threshold: 0.05
      invariant:
        - "Cosine similarity remains the primary semantic metric."
        - "Amplitude filtering acts only as local stability gate."
        - "No basis removal; only ranking attenuation."

    # ----------------------------------------
    # 2B) Loop / Howling Detection
    # ----------------------------------------
    loop_detection:
      signal: dEdb_stable_count
      trigger_condition: "> 5"
      purpose: "Detect oscillatory decoding without semantic progression."
      invariant:
        - "Loop detection does not inspect or modify wave state."

    # ----------------------------------------
    # 2C) Strategy Adjustment (Snap)
    # ----------------------------------------
    strategy_adjustment:
      action: attractor_snap
      snap_method: weight_rebalancing_toward_centroid

      rebalancing:
        method: soft_weight_bias
        formula: |
          w_i' = normalize(
            w_i * (1 - alpha) +
            alpha * centroid_similarity_i
          )
        alpha: 0.15
        clamp_min_weight: 0.0
        clamp_max_weight: 1.0

      invariant:
        - "Rebalancing modifies projection weights only."
        - "No single basis is forced to weight=1."
        - "Mixture superposition is preserved."
        - "Sampling remains stochastic."

  # ------------------------------------------------------------
  # 3) Post-Stabilization Decode
  # ------------------------------------------------------------
  post_adjustment_decode:
    input: adjusted_projection_sparse_mixture
    output: stabilized_logits_map
    invariant:
      - "Decoder produces logits via geometric superposition."
      - "No deterministic selection occurs before sampling."

  # ------------------------------------------------------------
  # 4) Philosophical Compliance Check
  # ------------------------------------------------------------
  compliance:
    checks:
      - "No wave state mutation."
      - "No semantic space mutation."
      - "No collapse outside sampling."
      - "No deterministic override of mixture."
    failure_action: abort_adjustment

# ============================================================
# 8) LEARNING (OBSERVATION-CONDITIONAL UPDATES)
# ============================================================
learning:
  policy:
    logs_persistent: false
    aggregates_persistent: true

  reward:
    sources:
      - self_consistency
      - user_feedback_optional
      - task_success_optional
    note: "Reward definition is external and replaceable."

  updates:
    basis_strength:
      rule: "basis_strength += reward * projection_weight"
      target: meaning_space.basis.strength

    basis_stability:
      rule: "stability = ema(stability, observed_success, stability_ema)"
      ema: runtime.meaning_space.stability_ema
      target: meaning_space.basis.stability

    basis_vector:
      rule: "vec = ema(vec, geom_proj, vector_ema)"
      ema: runtime.meaning_space.vector_ema
      source_geom: spectral_observer.output.band_features
      target: meaning_space.basis.vec

    token_basis_association:
      rule: "assoc_weight += reward * projection_weight"
      target_table: token_basis

    pattern_next:
      rule: "count += reward"
      target_table: pattern_next

    bigram:
      rule: "count += reward * 0.25"
      target_table: bigram

# ============================================================
# 9) LEARNING DOMINANCE (PREVENT WEB DOMINATION)
# ============================================================
learning_dominance:
  priority_order:
    - local_experience
    - user_interaction
    - internal_inference_artifacts
    - external_observation_web
  quotas:
    external_observation_max_ratio: runtime.learning_dominance.external_observation_max_ratio
  enforcement_stage: post_accumulation
    weights:
      local: runtime.mastication.local_learning_weight
      web: runtime.mastication.web_learning_weight

# ============================================================
# Semantic Freeze (Meaning Space Identity Preservation)
# ============================================================

semantic_freeze:

  enabled: false

  authority:
    required_role: administrator
    required_confirmation: true

  purpose:
    description: >
      Freeze meaning space topology to preserve semantic identity at a specific point in time.
      Inference remains operational while learning and semantic mutation are prohibited.

  invariants:

    meaning_space_mutation: prohibited

    prohibits:
      - basis_creation
      - basis_vector_update
      - basis_strength_update
      - basis_stability_update
      - transition_statistics_update
      - decoherence_creation
      - band_refinement_merge
      - external_observation_integration
      - mastication_learning

    allows:
      - inference
      - projection
      - decoding
      - similarity_search
      - read_only_index_access

  persistence:

    freeze_timestamp: required

    freeze_state_hash:
      enabled: true
      algorithm: sha256

    integrity_verification:
      required_on_load: true

  reversibility:

    unfreeze_allowed: true

    authority_required: administrator

    audit_log_required: true

  distributed_behavior:

    export_allowed: false

    import_allowed: false

    reason: >
      Frozen semantic state must remain locally authoritative and immutable.
semantic_snapshot:

  enabled: true

  authority_required: administrator

  export:

    format:
      - sqlite
      - binary

    include:
      - basis_table
      - transition_statistics
      - reinforcement_state
      - semantic_index

    integrity_hash:
      algorithm: sha256

  restore:

    overwrite_existing: optional

    integrity_verification: required
# ============================================================
# 10) FALLBACK HIERARCHY (TIER-1 BLEND → TIER-2 ASK → TIER-3 WEB)
# ============================================================
fallback_hierarchy:
  enabled: true
  tiers:
    tier_1_concept_blending:
      name: "Concept Blending"
      goal: "Approximate unknown input using combinations of existing bases before asking or searching."
      trigger:
        signal: meaning_space.projection.residual.output_name
        condition: { type: above_threshold, value: runtime.fallback.residual_for_blend }
      action:
        - attempt_multi_basis_decode
        - reduce_entropy_via_blend
      constraints:
        max_bases_to_blend: runtime.fallback.blend_max_bases
        min_basis_weight: runtime.fallback.blend_min_weight

    tier_2_active_querying:
      name: "Active Querying"
      goal: "Ask the user for clarification when uncertainty remains high."
      trigger:
        all_of:
          - { signal: logits_entropy, type: above_threshold, value: runtime.fallback.entropy_for_question }
          - { signal: user_present, type: equals, value: true }
      action:
        - generate_clarifying_question
        - mark_question_mode
      constraints:
        rate_limit_questions_per_minute: runtime.fallback.question_rate_limit_per_minute

    tier_3_external_observation_web:
      name: "External Observation (Web)"
      goal: "Observe external sources only when internal + user querying cannot resolve."
      trigger:
        all_of:
          - { signal: spectral_gradient_band, type: above_threshold, value: runtime.external_observation.gradient_threshold }
          - { signal: projection_residual, type: above_threshold, value: runtime.external_observation.residual_threshold }
          - { signal: logits_entropy, type: above_threshold, value: runtime.external_observation.entropy_threshold }
          - { signal: user_answer_unavailable, type: equals, value: true }
      action:
        - external_observation.web_search
        - internal_mastication.pipeline

# ============================================================
# 11) INTERNAL MASTICATION (WEB → TOKEN STREAM → WAVE → OBSERVE → UPDATE)
# ============================================================
internal_mastication:
  definition: >
    External text becomes a virtual token stream processed through Wave Core (silent reading).
    Only wave-derived observations may update aggregates. Raw text is discarded post-mastication.
  invariants:
    - "External text MUST NOT update aggregates without wave observation."
    - "Mastication is non-generative: sampling disabled; no user-visible output."
    - "Post-mastication only aggregates persist; raw text is discarded."

  budget:
    cap_per_day:
      web_docs_max: runtime.mastication.web_docs_max_per_day
      web_tokens_max: runtime.mastication.web_tokens_max_per_day

  pipeline:
    steps:
      - normalize_text
      - chunk_text
      - tokenize_mecab

      - replay_as_virtual_experience:
          mode: silent_reading
          output_generation: runtime.mastication.silent_reading_generation
          sampling: runtime.mastication.silent_reading_sampling
          notes:
            - "This route executes wave_core_update per token but does NOT sample output."

      - wave_core_update
      - spectral_observe_band
      - meaning_space_project

      - learning_update:
          allowed_targets:
            - token_basis_association
            - basis_vector
            - basis_strength
            - basis_stability
            - pattern_next
            - bigram
          weighting:
            relative_weight: runtime.mastication.web_learning_weight

      - discard_raw_text

# ============================================================
# 12) EXTERNAL OBSERVATION (WEB SEARCH) — TIER-3 ONLY + MASTICATION-GATED
# ============================================================
external_observation:
  enabled: runtime.external_observation.enabled
  mode: web_search_fallback

  invariants:
    - "External observation is accessed ONLY via fallback_hierarchy.tier_3."
    - "No direct aggregates_update from web content is permitted."
    - "Web content is observation-only; raw text is discarded after mastication."

  triggers:
    # Separation guarantee:
    # - Basis creation: similarity-only (handled in meaning_space.basis_lifecycle.decoherence)
    # - Web search: gradient-high only AND only when tier-3 conditions are satisfied
    web_search:
      via: fallback_hierarchy.tiers.tier_3_external_observation_web

  query_builder:
    source: gradient_aligned_tokens
    alignment_ref: spectral_alignment.token_band_binding.output.token_to_band
    token_filter:
      pos_include: [noun, verb, adjective]
      pos_exclude: [particle, auxiliary, symbol]
    select_topK: runtime.external_observation.query_topK
    compose: { method: whitespace_join }

  web_search:
    query_builder_method: external_observation.query_builder
    fetch_policy:
      respect_robots_txt: true
      rate_limit_seconds_per_domain: 20
      cache_ttl_hours: 72
      user_agent: "WaveLLMOS-Observer/0.2"
    extract:
      method: readable_text
      max_chars: 8000
      chunk_chars: 1200

  integration:
    route:
      method: internal_mastication
      target: internal_mastication.pipeline
    persistence:
      raw_text: discard

  safety:
    prohibit:
      - login_required_sources
      - terms_disallow_crawling
      - personal_data_collection

# ============================================================
# 13) CONSTRAINT LAYER (LEVEL 4) — MANIFEST ONLY
# ============================================================
constraint_layer:
  rule_source: manifest_only
  manifest_path: "manifests/constraints.yaml"
  apply_stage: post_logit_pre_sampling
  influence_cap: runtime.constraints.influence_cap
  invariants:
    - "No constraint rule definitions exist in source code."
    - "Constraints cannot exceed influence_cap."
    - "Constraints stabilize form, never originate meaning."

# ============================================================
# 14) AXIS ROUTING (OPTIONAL)
# ============================================================
axis_routing:
  enabled: runtime.axis_routing.enabled
  role: candidate_space_filter
  manifest_path: "manifests/axis.yaml"
  invariants:
    - "Filter-only. No modification of wave state, projection, or basis vectors."

# ============================================================
# 15) GENERATION PIPELINE (ORDER IS LAW)
# ============================================================
generation_pipeline:
  collapse: sampling
  steps:
    - tokenize_input
    - loop_per_token:
        - wave_core_update
        - spectral_observe
        - meaning_space_project
        - basis_lifecycle_decoherence_check
        - db_decoder_logits
        - constraint_apply
        - sample_next_token
        - learning_update
        - basis_lifecycle_coherence_check
        - fallback_hierarchy_check_optional
  sampling:
    temperature: runtime.sampling.temperature
    top_k: runtime.sampling.top_k
    top_p: runtime.sampling.top_p

# ============================================================
# 16) STORAGE (SQLITE MINIMUM SCHEMA SPEC) — LABEL IS DICTIONARY
# ============================================================
storage:
  engine: sqlite
  schema:
    tables:
      basis:
        primary_key: basis_id
        columns:
          - { name: basis_id, type: TEXT }
          - { name: vec_blob, type: BLOB }          # float32 packed
          - { name: strength, type: REAL }
          - { name: stability, type: REAL }
          - { name: dormant, type: INTEGER }        # 0/1
          - { name: label_cache, type: TEXT, nullable: true }
          - { name: created_at, type: INTEGER }
          - { name: updated_at, type: INTEGER }

      token_basis:
        primary_key: [token_id, basis_id]
        columns:
          - { name: token_id, type: INTEGER }
          - { name: basis_id, type: TEXT }
          - { name: weight, type: REAL }
          - { name: updated_at, type: INTEGER }

      pattern_next:
        primary_key: [pattern_key, next_token_id]
        columns:
          - { name: pattern_key, type: TEXT }
          - { name: next_token_id, type: INTEGER }
          - { name: count, type: REAL }
          - { name: updated_at, type: INTEGER }

      bigram:
        primary_key: [prev_token_id, next_token_id]
        columns:
          - { name: prev_token_id, type: INTEGER }
          - { name: next_token_id, type: INTEGER }
          - { name: count, type: REAL }
          - { name: updated_at, type: INTEGER }

      # reverse dictionary: basis_id -> label (metadata only)
      basis_label_dictionary:
        primary_key: basis_id
        columns:
          - { name: basis_id, type: TEXT }
          - { name: label, type: TEXT }
          - { name: label_confidence, type: REAL, nullable: true }
          - { name: updated_at, type: INTEGER }

    indexes:
      - { table: basis_label_dictionary, columns: [label] }  # admin UI filtering only

# ============================================================
# 17) IMPLEMENTATION INTERFACES (REFERENCE)
# ============================================================
interfaces:
  WaveCore:
    methods:
      - "update(token_id) -> None"
      - "get_ring() -> psi_ring"

  SpectralObserver:
    methods:
      - "observe(psi_ring) -> band_features"
      - "gradient(band_features_t, band_features_t_1) -> {dEdb, ddEdb}"

  MeaningSpace:
    methods:
      - "project(band_features) -> projection_sparse_mixture"
      - "decoherence_check(max_cos, band_features) -> created_basis_id|None"
      - "coherence_check(basis_id) -> label|None"
      - "ensure_vector_indexed(basis_id, vec) -> None"
      - "upsert_label_dictionary(basis_id, label, confidence|null) -> None"

  DBDecoder:
    methods:
      - "logits(projection_sparse_mixture, prev_token_id) -> logits_map"
      - "pattern_key(projection_sparse_mixture) -> pattern_key"

  ConstraintsEngine:
    methods:
      - "apply(prefix_tokens, logits_map, state) -> logits_map"

  Learner:
    methods:
      - "update(reward, projection, prev_token_id, next_token_id, band_features) -> None"
      - "update_weighted(reward, weight, projection, prev_token_id, next_token_id, band_features) -> None"

  ExternalObserver:
    methods:
      - "build_query(gradient_aligned_tokens) -> query_string"
      - "fetch(query_string) -> raw_text_chunks"
      - "mastication_ingest(raw_text_chunks) -> None"


